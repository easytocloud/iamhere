#! /usr/bin/env bash
#
# iamhere: script to change security group rules in current AWS account and region based on 'tags'
#
# We use the term TAG whereas really it is the Description Field we check for, as this is easier to edit in the AWS Console
#

DEFAULT_IAMHERE_TAG=${DEFAULT_IAMHERE_TAG:-myHomeIP}

TAG=${DEFAULT_IAMHERE_TAG}
if [ "$#" == 1 ] ; then
    TAG="${1}"
else
    echo "Not a single tag provided, defaulting to ${TAG}" >&2
fi

QUERY='SecurityGroupRules[?Description==`'"${TAG}"'`].[SecurityGroupRuleId,GroupId,IpProtocol,FromPort,ToPort]'
NEWIP=$(curl -s http://whatismyip.akamai.com/)

let count=0

while read sgr gid IpProtocol FromPort ToPort
do
    echo SecurityGroup Rule: ${sgr}
    echo SecurityGroup Id: ${gid}

    echo Change Ingress IP to ${NEWIP}

    aws ec2 modify-security-group-rules \
    --group-id ${gid} \
    --security-group-rules "SecurityGroupRuleId=${sgr},SecurityGroupRule={Description=\"${TAG}\",IpProtocol=${IpProtocol},FromPort=${FromPort},ToPort=${ToPort},CidrIpv4=${NEWIP}/32}" > /dev/null
    if [ $? -eq 0 ]
    then
        let count+=1
        echo "Done"
    else
        echo "Failed"
    fi
done < <(aws ec2 describe-security-group-rules --query "${QUERY}" --output text)

echo "${count} SecurityGroup Rules changed" >&2


